<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AudioInsight - AI Audio Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: #f8fafc;
            min-height: 100vh;
        }

        .card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .input-field {
            background: white;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
        }

        .btn-icon {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }

        .btn-icon.recording {
            background: #fef2f2;
            border-color: #fecaca;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }

        .message-user {
            background: linear-gradient(135deg, #ede9fe 0%, #e0e7ff 100%);
            border: 1px solid #c7d2fe;
        }

        .message-assistant {
            background: white;
            border: 1px solid #e2e8f0;
        }

        .tag {
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
        }

        .tag-primary {
            background: #eef2ff;
            color: #4f46e5;
            border: 1px solid #c7d2fe;
        }

        .tag-success {
            background: #ecfdf5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .tag-warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .tag-danger {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .progress-bar {
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #a855f7);
            background-size: 200% 100%;
            animation: shimmer 2s infinite linear;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .typing-indicator span {
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.2s ease;
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: #6366f1;
            background: #f5f3ff;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .section-title {
            color: #64748b;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 sticky top-0 z-50">
            <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center">
                        <i data-lucide="audio-waveform" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-900">AudioInsight</h1>
                        <p class="text-xs text-gray-500">AI-Powered Audio Analysis</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 text-xs text-gray-500">
                        <span id="status-dot" class="w-2 h-2 rounded-full bg-emerald-500"></span>
                        <span id="provider-status">Ready</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col max-w-3xl mx-auto w-full px-4 py-6">
            <!-- Welcome Section -->
            <div id="welcome-section" class="flex-1 flex flex-col items-center justify-center text-center py-8">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center mb-5">
                    <i data-lucide="mic" class="w-8 h-8 text-indigo-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Audio Transcription & Analysis</h2>
                <p class="text-gray-500 max-w-md mb-8">
                    Upload audio, record your voice, or paste text for instant AI analysis including summarization, intent detection, and keyword extraction.
                </p>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full max-w-xl mb-6">
                    <button onclick="showUploadModal()" class="card p-4 rounded-xl hover:border-indigo-200 transition-all text-left group">
                        <div class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center mb-3 group-hover:bg-indigo-100 transition-colors">
                            <i data-lucide="upload" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <h3 class="font-medium text-gray-900 mb-1">Upload Audio</h3>
                        <p class="text-xs text-gray-500">MP3, WAV, FLAC, M4A</p>
                    </button>

                    <button onclick="startVoiceRecording()" class="card p-4 rounded-xl hover:border-indigo-200 transition-all text-left group">
                        <div class="w-10 h-10 rounded-lg bg-purple-50 flex items-center justify-center mb-3 group-hover:bg-purple-100 transition-colors">
                            <i data-lucide="mic" class="w-5 h-5 text-purple-600"></i>
                        </div>
                        <h3 class="font-medium text-gray-900 mb-1">Voice Input</h3>
                        <p class="text-xs text-gray-500">Speak, see text appear</p>
                    </button>

                    <button onclick="focusInput()" class="card p-4 rounded-xl hover:border-indigo-200 transition-all text-left group">
                        <div class="w-10 h-10 rounded-lg bg-emerald-50 flex items-center justify-center mb-3 group-hover:bg-emerald-100 transition-colors">
                            <i data-lucide="type" class="w-5 h-5 text-emerald-600"></i>
                        </div>
                        <h3 class="font-medium text-gray-900 mb-1">Paste Text</h3>
                        <p class="text-xs text-gray-500">Analyze any content</p>
                    </button>
                </div>

                <!-- Example Prompts -->
                <div class="w-full max-w-xl">
                    <p class="section-title mb-3">Try an example</p>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button onclick="useExample(0)" class="tag px-3 py-1.5 rounded-full text-sm hover:bg-gray-100 transition-colors">
                            Customer complaint
                        </button>
                        <button onclick="useExample(1)" class="tag px-3 py-1.5 rounded-full text-sm hover:bg-gray-100 transition-colors">
                            Meeting notes
                        </button>
                        <button onclick="useExample(2)" class="tag px-3 py-1.5 rounded-full text-sm hover:bg-gray-100 transition-colors">
                            Product feedback
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages -->
            <div id="messages-container" class="hidden flex-1 overflow-y-auto space-y-4 pb-4"></div>

            <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden flex items-center gap-2 text-gray-500 py-3">
                <div class="typing-indicator flex gap-1">
                    <span class="w-2 h-2 rounded-full bg-indigo-500"></span>
                    <span class="w-2 h-2 rounded-full bg-purple-500"></span>
                    <span class="w-2 h-2 rounded-full bg-pink-500"></span>
                </div>
                <span class="text-sm" id="typing-text">Analyzing...</span>
            </div>

            <!-- Progress Bar -->
            <div id="progress-container" class="hidden mb-4">
                <div class="h-1 w-full bg-gray-100 rounded-full overflow-hidden">
                    <div id="progress-bar" class="progress-bar h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-xs text-gray-500 mt-2">Processing...</p>
            </div>
        </main>

        <!-- Input Section -->
        <div class="bg-white border-t border-gray-200 sticky bottom-0">
            <div class="max-w-3xl mx-auto px-4 py-3">
                <div class="flex items-end gap-2">
                    <!-- Upload Button -->
                    <button onclick="showUploadModal()" class="btn-icon p-2.5 rounded-lg" title="Upload Audio">
                        <i data-lucide="paperclip" class="w-5 h-5 text-gray-500"></i>
                    </button>

                    <!-- Voice Record Button -->
                    <button id="voice-btn" onclick="toggleVoiceRecording()" class="btn-icon p-2.5 rounded-lg" title="Record Voice">
                        <i data-lucide="mic" class="w-5 h-5 text-gray-500" id="mic-icon"></i>
                    </button>

                    <!-- Text Input -->
                    <div class="flex-1 relative">
                        <textarea
                            id="main-input"
                            placeholder="Type or paste text to analyze..."
                            class="w-full input-field rounded-xl px-4 py-2.5 resize-none text-sm min-h-[44px] max-h-[200px]"
                            rows="1"
                            onkeydown="handleKeyDown(event)"
                            oninput="autoResize(this)"
                        ></textarea>
                    </div>

                    <!-- Send Button -->
                    <button onclick="sendMessage()" id="send-btn" class="btn-primary p-2.5 rounded-lg disabled:opacity-50" disabled>
                        <i data-lucide="arrow-up" class="w-5 h-5"></i>
                    </button>
                </div>

                <!-- Task Options -->
                <div class="flex items-center gap-4 mt-2.5 text-xs">
                    <label class="flex items-center gap-1.5 cursor-pointer text-gray-600 hover:text-gray-900 transition-colors">
                        <input type="checkbox" id="task-summarize" checked class="w-3.5 h-3.5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span>Summary</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-gray-600 hover:text-gray-900 transition-colors">
                        <input type="checkbox" id="task-intent" checked class="w-3.5 h-3.5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span>Intent</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-gray-600 hover:text-gray-900 transition-colors">
                        <input type="checkbox" id="task-keywords" checked class="w-3.5 h-3.5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span>Keywords</span>
                    </label>
                    <label class="flex items-center gap-1.5 cursor-pointer text-gray-600 hover:text-gray-900 transition-colors">
                        <input type="checkbox" id="task-translate" class="w-3.5 h-3.5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span>Translate</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Upload Modal -->
        <div id="upload-modal" class="fixed inset-0 bg-black/30 backdrop-blur-sm z-50 hidden items-center justify-center">
            <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-xl fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Upload Audio File</h3>
                    <button onclick="hideUploadModal()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
                    </button>
                </div>

                <div id="drop-zone" class="drop-zone rounded-xl p-8 text-center cursor-pointer" onclick="document.getElementById('file-input').click()">
                    <input type="file" id="file-input" class="hidden" accept=".mp3,.wav,.flac,.m4a,.ogg,.aac,.wma" onchange="handleFileSelect(event)">
                    <div class="w-14 h-14 rounded-full bg-indigo-50 flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="upload-cloud" class="w-7 h-7 text-indigo-600"></i>
                    </div>
                    <p class="text-gray-700 font-medium mb-1">Drop your audio file here</p>
                    <p class="text-sm text-gray-500">or click to browse</p>
                    <p class="text-xs text-gray-400 mt-3">MP3, WAV, FLAC, M4A, OGG, AAC, WMA</p>
                </div>

                <div id="file-info" class="hidden mt-4 p-3 bg-gray-50 rounded-xl border border-gray-200">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg bg-indigo-50 flex items-center justify-center">
                            <i data-lucide="file-audio" class="w-5 h-5 text-indigo-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p id="file-name" class="font-medium text-gray-900 truncate"></p>
                            <p id="file-size" class="text-xs text-gray-500"></p>
                        </div>
                        <button onclick="clearFile()" class="p-1.5 hover:bg-gray-200 rounded-lg transition-colors">
                            <i data-lucide="x" class="w-4 h-4 text-gray-500"></i>
                        </button>
                    </div>
                </div>

                <button id="upload-btn" onclick="uploadAndProcess()" class="btn-primary w-full py-2.5 rounded-xl mt-4 font-medium" disabled>
                    Upload & Analyze
                </button>
            </div>
        </div>

    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // State
        let ws = null;
        let clientId = 'client_' + Math.random().toString(36).substr(2, 9);
        let selectedFile = null;
        let isProcessing = false;

        // Speech Recognition State
        let recognition = null;
        let isListening = false;
        let finalTranscript = '';
        let speechRecognitionSupported = false;

        // Fallback: MediaRecorder for audio recording
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingTimer = null;

        // Example texts
        const examples = [
            "I've been a customer for 3 years and I'm extremely disappointed with the recent changes to your service. The new pricing is unreasonable and the support team has been unresponsive to my complaints. I'm considering switching to a competitor unless this is resolved.",
            "In today's meeting, we discussed the Q4 roadmap. Key decisions: Launch the new feature by November 15th, hire 2 additional developers, and increase marketing budget by 20%. Action items include John preparing the technical specs by Friday and Sarah scheduling interviews for next week.",
            "I absolutely love the new update! The interface is so much cleaner and the performance improvements are noticeable. The dark mode feature is exactly what I was hoping for. Great job to the development team!"
        ];

        // Initialize Speech Recognition with fallback to audio recording
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                console.warn('Speech Recognition not supported, using audio recording fallback');
                speechRecognitionSupported = false;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                speechRecognitionSupported = true;
                finalTranscript = document.getElementById('main-input').value;
                updateMicButton(true);
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }

                const input = document.getElementById('main-input');
                input.value = finalTranscript + interimTranscript;
                autoResize(input);
                updateSendButton();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);

                // On network error, fall back to audio recording
                if (event.error === 'network') {
                    console.log('Falling back to audio recording mode');
                    speechRecognitionSupported = false;
                    stopListening();
                    // Start audio recording instead
                    startAudioRecording();
                    return;
                }

                const errorMessages = {
                    'not-allowed': 'Microphone access denied. Please allow microphone access in your browser settings.',
                    'no-speech': 'No speech detected. Please try speaking again.',
                    'audio-capture': 'No microphone found. Please connect a microphone and try again.',
                    'aborted': 'Speech recognition was stopped.',
                    'service-not-allowed': 'Speech recognition service is not allowed. Please use HTTPS or localhost.'
                };

                const message = errorMessages[event.error] || `Speech recognition error: ${event.error}`;

                if (!['aborted', 'no-speech'].includes(event.error)) {
                    alert(message);
                }

                stopListening();
            };

            recognition.onend = () => {
                if (isListening && speechRecognitionSupported) {
                    try {
                        recognition.start();
                    } catch (e) {
                        stopListening();
                    }
                } else {
                    updateMicButton(false);
                }
            };
        }

        // Audio Recording Fallback (records and transcribes via Whisper)
        async function startAudioRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    stream.getTracks().forEach(track => track.stop());
                    clearInterval(recordingTimer);
                    updateMicButton(false);

                    if (audioChunks.length > 0) {
                        await processRecordedAudio();
                    }
                };

                mediaRecorder.start();
                recordingStartTime = Date.now();
                recordingTimer = setInterval(updateRecordingDisplay, 1000);
                isListening = true;
                updateMicButton(true);

                // Show recording indicator in input
                document.getElementById('main-input').placeholder = 'Recording... Click mic to stop and transcribe';

            } catch (err) {
                console.error('Failed to start audio recording:', err);
                alert('Could not access microphone. Please ensure you have granted permission.');
            }
        }

        function updateRecordingDisplay() {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('main-input').placeholder = `Recording ${mins}:${secs}... Click mic to stop`;
        }

        async function processRecordedAudio() {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            const file = new File([audioBlob], 'voice-recording.webm', { type: 'audio/webm' });

            document.getElementById('main-input').placeholder = 'Transcribing your voice...';

            try {
                const formData = new FormData();
                formData.append('file', file);

                const uploadResponse = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) throw new Error('Upload failed');

                const uploadResult = await uploadResponse.json();

                // Request transcription only
                const transcribeResponse = await fetch(`/api/transcribe/${uploadResult.file_id}`, {
                    method: 'POST'
                });

                if (transcribeResponse.ok) {
                    const result = await transcribeResponse.json();
                    if (result.text) {
                        const input = document.getElementById('main-input');
                        input.value = result.text;
                        autoResize(input);
                        updateSendButton();
                    }
                } else {
                    // If transcribe endpoint doesn't exist, just notify user
                    alert('Voice recorded! Audio file uploaded. Note: FFmpeg is required for transcription.');
                }

            } catch (error) {
                console.error('Failed to process recording:', error);
                alert('Failed to transcribe recording. Please type your message instead.');
            }

            document.getElementById('main-input').placeholder = 'Type or paste text to analyze...';
        }

        function toggleVoiceRecording() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            // Try speech recognition first, fall back to audio recording
            if (recognition && speechRecognitionSupported !== false) {
                try {
                    recognition.start();
                } catch (e) {
                    console.error('Failed to start recognition:', e);
                    startAudioRecording();
                }
            } else {
                startAudioRecording();
            }
        }

        function stopListening() {
            isListening = false;

            // Stop speech recognition if active
            if (recognition) {
                try {
                    recognition.stop();
                } catch (e) {
                    console.error('Failed to stop recognition:', e);
                }
            }

            // Stop audio recording if active
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }

            updateMicButton(false);
            document.getElementById('main-input').placeholder = 'Type or paste text to analyze...';
        }

        function updateMicButton(listening) {
            const btn = document.getElementById('voice-btn');
            const icon = document.getElementById('mic-icon');

            if (listening) {
                btn.classList.add('recording');
                btn.title = 'Stop recording';
                icon.setAttribute('data-lucide', 'mic-off');
            } else {
                btn.classList.remove('recording');
                btn.title = 'Start voice input';
                icon.setAttribute('data-lucide', 'mic');
            }
            lucide.createIcons();
        }

        function startVoiceRecording() {
            startListening();
        }

        // Initialize WebSocket
        function initWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws/${clientId}`);

            ws.onopen = () => {
                document.getElementById('provider-status').textContent = 'Connected';
                document.getElementById('status-dot').classList.remove('bg-yellow-500');
                document.getElementById('status-dot').classList.add('bg-emerald-500');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            ws.onclose = () => {
                document.getElementById('provider-status').textContent = 'Reconnecting...';
                document.getElementById('status-dot').classList.remove('bg-emerald-500');
                document.getElementById('status-dot').classList.add('bg-yellow-500');
                setTimeout(initWebSocket, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            if (data.type === 'status') {
                updateProgress(data.progress, data.message);
            } else if (data.type === 'complete') {
                hideProgress();
                hideTypingIndicator();
                addAssistantMessage(data.results);
                isProcessing = false;
            } else if (data.type === 'error') {
                hideProgress();
                hideTypingIndicator();
                addErrorMessage(data.message);
                isProcessing = false;
            }
        }

        // UI Functions
        function focusInput() {
            document.getElementById('main-input').focus();
        }

        function useExample(index) {
            const input = document.getElementById('main-input');
            input.value = examples[index];
            autoResize(input);
            updateSendButton();
            focusInput();
        }

        function showUploadModal() {
            document.getElementById('upload-modal').classList.remove('hidden');
            document.getElementById('upload-modal').classList.add('flex');
            setupDragDrop();
        }

        function hideUploadModal() {
            document.getElementById('upload-modal').classList.add('hidden');
            document.getElementById('upload-modal').classList.remove('flex');
            clearFile();
        }

        function setupDragDrop() {
            const dropZone = document.getElementById('drop-zone');
            ['dragover', 'dragenter'].forEach(e => {
                dropZone.addEventListener(e, (ev) => {
                    ev.preventDefault();
                    dropZone.classList.add('dragover');
                });
            });
            ['dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'));
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                if (e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
            });
        }

        function handleFileSelect(event) {
            if (event.target.files[0]) handleFile(event.target.files[0]);
        }

        function handleFile(file) {
            selectedFile = file;
            document.getElementById('file-info').classList.remove('hidden');
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = formatFileSize(file.size);
            document.getElementById('upload-btn').disabled = false;
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('file-info').classList.add('hidden');
            document.getElementById('file-input').value = '';
            document.getElementById('upload-btn').disabled = true;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        async function uploadAndProcess() {
            if (!selectedFile || isProcessing) return;

            isProcessing = true;
            hideUploadModal();
            showWelcome(false);
            addUserMessage(`Analyze audio file: ${selectedFile.name}`);
            showTypingIndicator('Uploading audio file...');

            try {
                const formData = new FormData();
                formData.append('file', selectedFile);

                const uploadResponse = await fetch('/api/upload', { method: 'POST', body: formData });
                if (!uploadResponse.ok) throw new Error('Upload failed');

                const uploadResult = await uploadResponse.json();
                showProgress();
                updateTypingText('Processing audio...');

                ws.send(JSON.stringify({
                    type: 'process_audio',
                    file_id: uploadResult.file_id,
                    tasks: getSelectedTasks()
                }));
            } catch (error) {
                hideTypingIndicator();
                addErrorMessage('Failed to upload file: ' + error.message);
                isProcessing = false;
            }
        }

        function getSelectedTasks() {
            const tasks = [];
            if (document.getElementById('task-summarize').checked) tasks.push('summarize');
            if (document.getElementById('task-intent').checked) tasks.push('intent');
            if (document.getElementById('task-keywords').checked) tasks.push('keywords');
            if (document.getElementById('task-translate').checked) tasks.push('translate');
            return tasks;
        }

        async function sendMessage() {
            const input = document.getElementById('main-input');
            const text = input.value.trim();
            if (!text || isProcessing) return;

            isProcessing = true;
            input.value = '';
            autoResize(input);
            updateSendButton();

            showWelcome(false);
            addUserMessage(text);
            showTypingIndicator('Analyzing text...');
            showProgress();

            ws.send(JSON.stringify({
                type: 'analyze_text',
                text: text,
                tasks: getSelectedTasks()
            }));
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
            updateSendButton();
        }

        function updateSendButton() {
            const input = document.getElementById('main-input');
            document.getElementById('send-btn').disabled = !input.value.trim() || isProcessing;
        }

        function showWelcome(show) {
            document.getElementById('welcome-section').classList.toggle('hidden', !show);
            document.getElementById('messages-container').classList.toggle('hidden', show);
        }

        function addUserMessage(content) {
            const container = document.getElementById('messages-container');
            container.innerHTML += `
                <div class="message-user rounded-xl p-4 fade-in">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                        </div>
                        <p class="text-sm text-gray-700 pt-1">${escapeHtml(content)}</p>
                    </div>
                </div>`;
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }

        function addAssistantMessage(results) {
            const container = document.getElementById('messages-container');
            let html = `<div class="message-assistant rounded-xl p-4 fade-in">
                <div class="flex items-start gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center flex-shrink-0">
                        <i data-lucide="sparkles" class="w-4 h-4 text-white"></i>
                    </div>
                    <div class="flex-1 min-w-0 space-y-4">`;

            // Transcription
            if (results.transcription) {
                html += `<div>
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="file-text" class="w-4 h-4 text-indigo-600"></i>
                        <span class="section-title">Transcription</span>
                        <span class="tag-primary px-2 py-0.5 rounded text-xs">${results.transcription.language}</span>
                    </div>
                    <p class="text-sm text-gray-700 bg-gray-50 rounded-lg p-3 border border-gray-100">${escapeHtml(results.transcription.text)}</p>
                </div>`;
            }

            // Summary
            if (results.summary) {
                html += `<div>
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="align-left" class="w-4 h-4 text-purple-600"></i>
                        <span class="section-title">Summary</span>
                    </div>
                    <p class="text-sm text-gray-700">${escapeHtml(results.summary.summary)}</p>`;
                if (results.summary.key_points && results.summary.key_points.length > 0) {
                    html += `<div class="mt-2 space-y-1">`;
                    results.summary.key_points.forEach(p => {
                        html += `<div class="flex items-start gap-2 text-sm text-gray-600">
                            <span class="text-purple-500 mt-0.5">â€¢</span>
                            <span>${escapeHtml(p)}</span>
                        </div>`;
                    });
                    html += `</div>`;
                }
                html += `</div>`;
            }

            // Intent
            if (results.intent) {
                const sentimentClass = {
                    'positive': 'tag-success',
                    'negative': 'tag-danger',
                    'neutral': 'tag',
                    'mixed': 'tag-warning'
                }[results.intent.sentiment] || 'tag';

                html += `<div>
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="target" class="w-4 h-4 text-pink-600"></i>
                        <span class="section-title">Intent Analysis</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <span class="tag-primary px-2.5 py-1 rounded-full text-xs font-medium capitalize">${results.intent.primary_intent}</span>
                        <span class="tag px-2.5 py-1 rounded-full text-xs">${Math.round(results.intent.confidence * 100)}% confidence</span>
                        <span class="${sentimentClass} px-2.5 py-1 rounded-full text-xs capitalize">${results.intent.sentiment}</span>
                        <span class="tag px-2.5 py-1 rounded-full text-xs capitalize">Urgency: ${results.intent.urgency}</span>
                    </div>
                    ${results.intent.reasoning ? `<p class="text-xs text-gray-500 italic">"${escapeHtml(results.intent.reasoning)}"</p>` : ''}
                </div>`;
            }

            // Keywords
            if (results.keywords && results.keywords.keywords) {
                html += `<div>
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="hash" class="w-4 h-4 text-cyan-600"></i>
                        <span class="section-title">Keywords</span>
                        <span class="text-xs text-gray-400">${results.keywords.domain}</span>
                    </div>
                    <div class="flex flex-wrap gap-1.5">`;
                results.keywords.keywords.slice(0, 12).forEach(k => {
                    html += `<span class="tag px-2 py-1 rounded text-xs">${escapeHtml(k.keyword)}</span>`;
                });
                html += `</div></div>`;
            }

            html += `</div></div></div>`;
            container.innerHTML += html;
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }

        function addErrorMessage(message) {
            const container = document.getElementById('messages-container');
            container.innerHTML += `
                <div class="tag-danger rounded-xl p-4 fade-in">
                    <div class="flex items-center gap-3">
                        <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                        <p class="text-sm text-red-700">${escapeHtml(message)}</p>
                    </div>
                </div>`;
            lucide.createIcons();
            container.scrollTop = container.scrollHeight;
        }

        function showTypingIndicator(text = 'Analyzing...') {
            document.getElementById('typing-indicator').classList.remove('hidden');
            document.getElementById('typing-text').textContent = text;
        }

        function updateTypingText(text) {
            document.getElementById('typing-text').textContent = text;
        }

        function hideTypingIndicator() {
            document.getElementById('typing-indicator').classList.add('hidden');
        }

        function showProgress() {
            document.getElementById('progress-container').classList.remove('hidden');
        }

        function hideProgress() {
            document.getElementById('progress-container').classList.add('hidden');
            document.getElementById('progress-bar').style.width = '0%';
        }

        function updateProgress(percent, text) {
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-text').textContent = text;
            updateTypingText(text);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initWebSocket();
            initSpeechRecognition();
            document.getElementById('main-input').addEventListener('input', updateSendButton);
        });
    </script>
</body>
</html>
